#!/bin/bash

TIMEOUT=$1
if [ -z "$TIMEOUT" ]; then
    TIMEOUT=10
fi

pushd $(dirname "$@")

FILE=$(basename "$@")

#Â setup a fifo in PIPE, read/writable as fd 3
PIPE=$(mktemp -u)
mkfifo "$PIPE"
exec 3<>"$PIPE"
rm "$PIPE"


listen_thread() {
    ps2client execiop -t $TIMEOUT "host:$FILE"
    return 1
}

parse_exit_code_thread() {
    GREPRES=$(grep -m 1 'loadmodule: id [[:digit:]]*, ret [[:digit:]]' <&3)
}

listen_thread &
PS2CLIENTPID=$(jobs -p %+)
parse_exit_code_thread &
GREPPID=$(jobs -p %+)
popd
if wait -n; then
	echo ""
	kill $GREPPID
	kill $PS2CLIENTPID
	EXITCODE=$(echo "$GREPRES" | grep -E -o ', ret [[:digit:]]+' | awk '{print $3}')
	exit $EXITCODE
else
    echo "Command didn't finish within the timeout."
    kill $GREPPID
    kill $PS2CLIENTPID
    exit 126
fi
echo "Something weird has happened!"
exit 2
